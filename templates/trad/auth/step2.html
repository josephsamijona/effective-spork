{% extends 'base_register.html' %}

{% block title %}Step 2 - Professional Qualifications{% endblock %}

{% block extra_css %}
<style>
    /* Styles personnalis√©s pour Select2 */
    .select2-container--default .select2-selection--multiple {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 12px;
        min-height: 100px;
    }

    .select2-container--default .select2-selection--multiple .select2-selection__choice {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        padding: 4px 8px;
        margin: 4px;
    }

    .select2-container--default .select2-results__option {
        background: rgba(0, 51, 102, 0.95);
        color: white;
    }

    .select2-container--default .select2-results__option--highlighted {
        background: rgba(255, 255, 255, 0.1);
    }

    .select2-dropdown {
        background: rgba(0, 51, 102, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
    }

    .select2-search__field {
        background: rgba(255, 255, 255, 0.1) !important;
        color: white !important;
    }

    .select2-selection__choice__remove {
        color: rgba(255, 255, 255, 0.6) !important;
        margin-right: 5px;
    }

    .json-field-info {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 0.5rem;
    }

    .json-example {
        background: rgba(255, 255, 255, 0.05);
        padding: 0.5rem;
        border-radius: 6px;
        margin-top: 0.25rem;
        font-family: monospace;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block form_content %}
<div class="registration-step active">
    <!-- Languages Selection -->
    <div class="form-group">
        <label for="languages">Languages</label>
        <div class="input-wrapper">
            <i class="input-icon fas fa-language"></i>
            <select id="languages" 
                    name="languages" 
                    class="form-control select2-multiple" 
                    multiple 
                    required>
                {% for language in languages %}
                <option value="{{ language.id }}" 
                        {% if language.id|stringformat:"s" in selected_languages %}selected{% endif %}>
                    {{ language.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% if form.languages.errors %}
        <div class="error-message">
            {% for error in form.languages.errors %}
                <span>{{ error }}</span>
            {% endfor %}
        </div>
        {% endif %}
        <div class="help-text">Select all languages you can interpret</div>
    </div>

    <!-- Certifications Field -->
    <div class="form-group">
        <label for="certifications">Certifications (Optional)</label>
        <div class="input-wrapper">
            <i class="input-icon fas fa-certificate"></i>
            <textarea id="certifications" 
                      name="certifications" 
                      class="form-control {% if form.certifications.errors %}error{% endif %}" 
                      rows="3">{{ form.certifications.value|default:'' }}</textarea>
        </div>
        {% if form.certifications.errors %}
        <div class="error-message">
            {% for error in form.certifications.errors %}
                <span>{{ error }}</span>
            {% endfor %}
        </div>
        {% endif %}
        <div class="json-field-info">
            Enter your certifications in JSON format:
            <div class="json-example">
                [
    {"name": "CCHI", "expiry_date": "2025-01-01"},
    {"name": "Medical Interpreter", "expiry_date": "2024-12-31"}
]
            </div>
        </div>
    </div>

    <!-- Specialties Field -->
    <div class="form-group">
        <label for="specialties">Specialties (Optional)</label>
        <div class="input-wrapper">
            <i class="input-icon fas fa-star"></i>
            <textarea id="specialties" 
                      name="specialties" 
                      class="form-control {% if form.specialties.errors %}error{% endif %}" 
                      rows="3">{{ form.specialties.value|default:'' }}</textarea>
        </div>
        {% if form.specialties.errors %}
        <div class="error-message">
            {% for error in form.specialties.errors %}
                <span>{{ error }}</span>
            {% endfor %}
        </div>
        {% endif %}
        <div class="json-field-info">
            Enter your specialties in JSON format:
            <div class="json-example">
                ["Medical", "Legal", "Technical"]
            </div>
        </div>
    </div>

    <!-- Hidden hourly rate field -->
    <input type="hidden" name="hourly_rate" value="0">
</div>
{% endblock %}

{% block prev_url %}{% url 'dbdint:interpreter_registration_step1' %}{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Initialisation de Select2 pour les langues
    $('.select2-multiple').select2({
        theme: "default",
        placeholder: "Select your languages",
        allowClear: true,
        width: '100%',
        containerCssClass: 'select2-container--transparent'
    });

    // Validation JSON pour les certifications
    function validateJSON(field) {
        const value = field.value.trim();
        if (value) {
            try {
                JSON.parse(value);
                field.setCustomValidity('');
                return true;
            } catch (e) {
                field.setCustomValidity('Please enter valid JSON format');
                return false;
            }
        }
        field.setCustomValidity('');
        return true;
    }

    // Ajout des validateurs JSON
    const certificationsField = document.getElementById('certifications');
    const specialtiesField = document.getElementById('specialties');

    certificationsField.addEventListener('change', function() {
        validateJSON(this);
    });

    specialtiesField.addEventListener('change', function() {
        validateJSON(this);
    });

    // Validation du formulaire
    document.querySelector('form').addEventListener('submit', function(e) {
        const isValidCertifications = validateJSON(certificationsField);
        const isValidSpecialties = validateJSON(specialtiesField);
        const selectedLanguages = $('#languages').val();

        if (!isValidCertifications || !isValidSpecialties) {
            e.preventDefault();
            return false;
        }

        if (!selectedLanguages || selectedLanguages.length === 0) {
            e.preventDefault();
            const languagesField = document.getElementById('languages');
            languagesField.setCustomValidity('Please select at least one language');
            return false;
        }
    });
});
</script>
{% endblock %}