{% extends 'base_register.html' %}

{% block title %}Step 3 - Address Information{% endblock %}

{% block extra_css %}
<style>
    .address-preview {
        background: rgba(255, 255, 255, 0.05);
        padding: 1rem;
        border-radius: 12px;
        margin-top: 0.5rem;
        display: none;
    }

    .address-preview.active {
        display: block;
    }

    .custom-checkbox {
        position: relative;
        padding-left: 2rem;
        cursor: pointer;
        user-select: none;
        display: inline-block;
    }

    .custom-checkbox input {
        position: absolute;
        opacity: 0;
        cursor: pointer;
        height: 0;
        width: 0;
    }

    .checkmark {
        position: absolute;
        left: 0;
        top: 0;
        height: 1.5rem;
        width: 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        transition: all 0.3s ease;
    }

    .custom-checkbox input:checked ~ .checkmark {
        background: var(--accent-blue);
        border-color: var(--accent-blue);
    }

    .checkmark:after {
        content: "";
        position: absolute;
        display: none;
        left: 9px;
        top: 5px;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }

    .custom-checkbox input:checked ~ .checkmark:after {
        display: block;
    }

    .terms-link {
        color: var(--accent-blue);
        text-decoration: none;
        transition: color 0.3s ease;
    }

    .terms-link:hover {
        color: var(--secondary-blue);
        text-decoration: underline;
    }

    /* Animation for zip code validation */
    @keyframes validZip {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .zip-valid {
        animation: validZip 0.3s ease;
    }
</style>
{% endblock %}

{% block form_content %}
<div class="registration-step active">
    <!-- Address Field -->
    <div class="form-group">
        <label for="address">Complete Address</label>
        <div class="input-wrapper">
            <i class="input-icon fas fa-home"></i>
            <textarea id="address" 
                      name="address" 
                      class="form-control {% if form.address.errors %}error{% endif %}" 
                      rows="3" 
                      required 
                      placeholder="Enter your street address">{{ form.address.value|default:'' }}</textarea>
        </div>
        {% if form.address.errors %}
        <div class="error-message">
            {% for error in form.address.errors %}
                <span>{{ error }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- City & State Fields -->
    <div class="form-grid">
        <div class="form-group">
            <label for="city">City</label>
            <div class="input-wrapper">
                <i class="input-icon fas fa-city"></i>
                <input type="text" 
                       id="city" 
                       name="city" 
                       class="form-control {% if form.city.errors %}error{% endif %}" 
                       value="{{ form.city.value|default:'' }}"
                       required 
                       placeholder="Enter your city">
            </div>
            {% if form.city.errors %}
            <div class="error-message">
                {% for error in form.city.errors %}
                    <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="state">State</label>
            <div class="input-wrapper">
                <i class="input-icon fas fa-map-marker-alt"></i>
                <select id="state" 
                        name="state" 
                        class="form-control {% if form.state.errors %}error{% endif %}" 
                        required>
                    <option value="">Select your state</option>
                    {% for state_abbr, state_name in states.items %}
                    <option value="{{ state_abbr }}" 
                            {% if form.state.value == state_abbr %}selected{% endif %}>
                        {{ state_name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% if form.state.errors %}
            <div class="error-message">
                {% for error in form.state.errors %}
                    <span>{{ error }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ZIP Code Field -->
    <div class="form-group">
        <label for="zip_code">ZIP Code</label>
        <div class="input-wrapper">
            <i class="input-icon fas fa-map-pin"></i>
            <input type="text" 
                   id="zip_code" 
                   name="zip_code" 
                   class="form-control {% if form.zip_code.errors %}error{% endif %}" 
                   value="{{ form.zip_code.value|default:'' }}"
                   required 
                   pattern="[0-9]{5}" 
                   maxlength="5"
                   placeholder="Enter your ZIP code (5 digits)">
        </div>
        {% if form.zip_code.errors %}
        <div class="error-message">
            {% for error in form.zip_code.errors %}
                <span>{{ error }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- W9 Confirmation -->
    <div class="form-group">
        <label class="custom-checkbox">
            <input type="checkbox" 
                   id="w9_on_file" 
                   name="w9_on_file" 
                   {% if form.w9_on_file.value %}checked{% endif %} 
                   required>
            <span class="checkmark"></span>
            <span class="checkbox-text">
                I confirm that I will provide a W-9 form and understand that I cannot receive payments without it.
                <a href="#" class="terms-link" onclick="showW9Info(event)">Learn more</a>
            </span>
        </label>
        {% if form.w9_on_file.errors %}
        <div class="error-message">
            {% for error in form.w9_on_file.errors %}
                <span>{{ error }}</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Address Preview -->
    <div class="address-preview">
        <h4 class="preview-title">Address Preview</h4>
        <p id="preview-text"></p>
    </div>
</div>
{% endblock %}

{% block prev_url %}{% url 'dbdint:interpreter_registration_step2' %}{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Validation du code ZIP
    const zipInput = document.getElementById('zip_code');
    zipInput.addEventListener('input', function(e) {
        let value = this.value.replace(/\D/g, '');
        if (value.length > 5) value = value.slice(0, 5);
        this.value = value;
        
        if (value.length === 5) {
            this.classList.add('zip-valid');
            setTimeout(() => this.classList.remove('zip-valid'), 500);
        }
    });

    // Pr√©visualisation de l'adresse
    function updateAddressPreview() {
        const address = document.getElementById('address').value;
        const city = document.getElementById('city').value;
        const state = document.getElementById('state');
        const stateName = state.options[state.selectedIndex].text;
        const zip = document.getElementById('zip_code').value;

        if (address && city && state.value && zip) {
            const preview = document.querySelector('.address-preview');
            const previewText = document.getElementById('preview-text');
            preview.classList.add('active');
            previewText.innerHTML = `${address}<br>${city}, ${stateName} ${zip}`;
        }
    }

    ['address', 'city', 'state', 'zip_code'].forEach(id => {
        document.getElementById(id).addEventListener('change', updateAddressPreview);
        document.getElementById(id).addEventListener('keyup', updateAddressPreview);
    });

    // Validation du formulaire
    document.querySelector('form').addEventListener('submit', function(e) {
        const zip = document.getElementById('zip_code').value;
        if (!/^\d{5}$/.test(zip)) {
            e.preventDefault();
            document.getElementById('zip_code').setCustomValidity('Please enter a valid 5-digit ZIP code');
        } else {
            document.getElementById('zip_code').setCustomValidity('');
        }
    });
});

// Information W9
function showW9Info(e) {
    e.preventDefault();
    const info = `A W-9 form (Request for Taxpayer Identification Number and Certification) is required for payment processing. 
                 You will need to provide this form before receiving any payments for your interpretation services.`;
    alert(info);
}
</script>
{% endblock %}